# üóÑÔ∏è Database Sync Architecture

## üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: –ë–î –∫–∞–∫ Source of Truth

### üìä –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   Database       ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  Google Sheets  ‚îÇ
‚îÇ   (SvelteKit)   ‚îÇ    ‚îÇ   (SQLite)       ‚îÇ    ‚îÇ   (Mirror)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                       ‚îÇ                        ‚îÇ
        ‚îÇ                       ‚îÇ                        ‚îÇ
        ‚ñº                       ‚ñº                        ‚ñº
   –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤        –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π       –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è
   —á–µ—Ä–µ–∑ –∫–æ—Ä–∑–∏–Ω—É           –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã    —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
```

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

#### 1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π source of truth**
- ‚úÖ –í—Å–µ –∑–∞–∫–∞–∑—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î
- ‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –≤ –ë–î
- ‚úÖ –í—Å–µ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–¥—É—Ç –∏–∑ –ë–î

#### 2. **Telegram –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –ë–î**
- ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤: `orderService.getAllOrders()`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞: `orderService.updateOrderStatus()`
- ‚úÖ –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞: `orderService.getOrderById()`

#### 3. **–û–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ë–î ‚Üí Google Sheets**
- ‚úÖ –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: `syncOrderToSheets()`
- ‚úÖ –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: `syncStatusUpdate()`
- ‚úÖ –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¢–¢–ù: `syncTTNUpdate()` (—á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞)

#### 4. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞**
- ‚ùå `Google Sheets ‚Üí Database` —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞
- ‚ùå Auto-creation –∑–∞–∫–∞–∑–æ–≤ –∏–∑ Google Sheets –æ—Ç–∫–ª—é—á–µ–Ω–æ
- ‚ùå Sync –Ω–∞ —á—Ç–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ

### üîÑ Flow —Å–æ–∑–¥–∞–Ω–∏—è –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞–∫–∞–∑–∞

```
1. Frontend ‚Üí API ‚Üí OrderService.createOrder()
2. OrderService —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î
3. OrderService.syncNewOrder():
   ‚îú‚îÄ‚îÄ syncOrderToSheets() ‚Üí Google Sheets
   ‚îî‚îÄ‚îÄ notifyTelegramBot() ‚Üí Telegram
4. Telegram –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –ë–î
5. –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ Telegram ‚Üí OrderService.updateOrderStatus()
6. OrderService –æ–±–Ω–æ–≤–ª—è–µ—Ç –ë–î + —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Å Google Sheets
```

### üõ†Ô∏è API Endpoints

#### –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:
```bash
# –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤
POST /api/orders/sync-all
```

#### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)
POST /api/orders

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ (—Ç–æ–ª—å–∫–æ –∏–∑ –ë–î)
GET /api/orders
```

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

```bash
# –¢–µ—Å—Ç –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
npm run test-db-sync

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
npm run security:check
```

### üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

#### –õ–æ–≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:
```
[OrderService] üîÑ Starting full orders sync to Google Sheets...
[OrderService] Found 5 orders in database
[OrderService] Syncing order abc123...
[OrderService] ‚úÖ Synced order abc123
[OrderService] üîÑ Full sync completed:
  ‚úÖ Synced: 5
  ‚ùå Errors: 0
  üìä Total: 5
```

#### –õ–æ–≥–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π:
```
[OrderService] Updating order status: abc123 -> confirmed
[OrderService] Repository updateOrderStatus result: true
[OrderService] Status update successful, syncing...
[OrderService] Status synced to Google Sheets successfully: abc123, confirmed
```

### üîß –†—É—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ:

```javascript
// –í –∫–æ–¥–µ
await orderService.syncAllOrdersToSheets();

// –ß–µ—Ä–µ–∑ API
POST /api/orders/sync-all
```

### üìã Google Sheets —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

Google Sheets –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è –∏ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏:

| Column | Data | Source |
|--------|------|--------|
| A | Order ID | Database |
| B | Date | Database |
| C | Customer Name | Database |
| D | Phone | Database |
| E | Email | Database |
| F | Delivery Address | Database |
| G | Items | Database |
| H | Total | Database |
| I | Status | Database |
| J | TTN | Database |

### ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **Google Sheets - —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è** –¥–ª—è —Å–∏—Å—Ç–µ–º—ã
2. **–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –∏–¥—Ç–∏ —á–µ—Ä–µ–∑ –ë–î**
3. **–†—É—á–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Google Sheets –±—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã**
4. **–ë–î –≤—Å–µ–≥–¥–∞ –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç**

### üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –ë–î –∫–∞–∫ –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã
- ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ë—ã—Å—Ç—Ä–æ–µ —á—Ç–µ–Ω–∏–µ –∏–∑ –ë–î
- ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- ‚úÖ **–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å**: Google Sheets API –º–æ–∂–µ—Ç –ø–∞–¥–∞—Ç—å, –ë–î - –Ω–µ—Ç
- ‚úÖ **–ê—É–¥–∏—Ç**: –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –ë–î

### üö® Troubleshooting

#### –ü—Ä–æ–±–ª–µ–º–∞: –ó–∞–∫–∞–∑ –Ω–µ –ø–æ—è–≤–∏–ª—Å—è –≤ Google Sheets
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
grep "syncOrderToSheets" logs/*.log

# –†—É—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
POST /api/orders/sync-all
```

#### –ü—Ä–æ–±–ª–µ–º–∞: –°—Ç–∞—Ç—É—Å –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è –≤ Google Sheets
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
grep "syncStatusUpdate" logs/*.log

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API –∫–ª—é—á–∏ Google Sheets
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ
```

#### –ü—Ä–æ–±–ª–µ–º–∞: Telegram –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
```bash
# –ë–æ—Ç –≤—Å–µ–≥–¥–∞ —á–∏—Ç–∞–µ—Ç –∏–∑ –ë–î
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å orderService.getAllOrders()
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
```

### üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ –≤ –ë–î vs Google Sheets
- –í—Ä–µ–º—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –û—à–∏–±–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API Google Sheets

---

## üéâ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫ production!**

–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —è–≤–ª—è–µ—Ç—Å—è –Ω–∞–¥–µ–∂–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –ø—Ä–∞–≤–¥—ã, Google Sheets - —É–¥–æ–±–Ω—ã–º –∑–µ—Ä–∫–∞–ª–æ–º –¥–ª—è –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏, –∞ Telegram –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–æ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ! üöÄ
